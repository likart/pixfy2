# Новая система загрузки файлов на фотобанк

## Описание алгоритма

Система загрузки файлов была полностью переработана согласно новому алгоритму:

### 1. Этап загрузки во временную папку
- Файлы загружаются во временную папку конкретного пользователя (`media/temp/users/{user_id}/`)
- Выполняется только базовая проверка типа файла и размера
- Никакой дополнительной обработки на этом этапе не происходит

### 2. Фоновая обработка каждые 5 секунд
- Специальная Django команда `process_temp_files` проверяет все временные папки пользователей
- Если находятся файлы - запускается процесс полной обработки

### 3. Проверки файлов
1. **Целостность файлов** - проверяется что файл не поврежден и может быть открыт как изображение
2. **Тип файла** - проверяется что это JPG файл
3. **Размеры** - проверяются минимальные (100x100) и максимальные (10000x10000) размеры
4. **Размер файла** - максимум 50 МБ
5. **Дубликаты** - проверка по SHA256 хешу файла

### 4. Извлечение метаданных через ExifTool
- Используется ExifTool для чтения EXIF, IPTC и XMP метаданных
- Автоматически извлекаются: название, описание, ключевые слова
- Поддерживается корректная обработка UTF-16 кодировки (Windows XP теги)

### 5. Добавление на сервер
- После успешной обработки файл перемещается в постоянное хранилище
- Создается запись в базе данных с извлеченными метаданными
- Автоматическое создание превью изображения
- Фотографии сразу становятся доступными в галерее

## Новый интерфейс

Интерфейс страницы загрузки полностью переработан:
- Убраны все поля для ввода названий, описаний, ключевых слов
- Оставлен только drag & drop для файлов и прогресс-бар
- Современный дизайн с анимациями и визуальной обратной связью
- Отображение статистики загрузки в реальном времени

## Запуск системы

### 1. Запуск веб-сервера
```bash
python3 manage.py runserver
```

### 2. Запуск фоновой обработки файлов
В отдельном терминале:
```bash
python3 manage.py process_temp_files
```

Параметры команды:
- `--interval 5` - интервал проверки в секундах (по умолчанию 5)
- `--once` - выполнить только одну итерацию (для тестирования)

Примеры:
```bash
# Запуск с интервалом 10 секунд
python3 manage.py process_temp_files --interval 10

# Одноразовая проверка (для тестирования)
python3 manage.py process_temp_files --once
```

## Логирование

Система использует Django логирование для отслеживания процесса:
- Загрузка файлов во временные папки
- Обработка и валидация файлов
- Ошибки и предупреждения
- Статистика обработанных файлов

Логи можно посмотреть в консоли при запуске команд.

## Файлы системы

### Основные изменения:
- `templates/gallery/upload.html` - новый упрощенный интерфейс
- `gallery/views.py` - добавлен view `upload_to_temp`
- `gallery/urls.py` - добавлен URL для временной загрузки
- `gallery/models.py` - добавлено поле `file_hash` для проверки дубликатов
- `gallery/management/commands/process_temp_files.py` - команда фоновой обработки

### Структура папок:
```
media/
├── temp/
│   └── users/
│       ├── 1/          # Временные файлы пользователя ID 1
│       ├── 2/          # Временные файлы пользователя ID 2
│       └── ...
├── photos/             # Постоянное хранилище фотографий
└── thumbnails/         # Превью изображений
```

## Преимущества новой системы

1. **Надежность** - файлы тщательно проверяются перед добавлением
2. **Производительность** - загрузка не блокируется тяжелой обработкой
3. **Простота использования** - минимум действий от пользователя
4. **Автоматизация** - метаданные извлекаются автоматически
5. **Защита от дубликатов** - проверка по хешу файла
6. **Масштабируемость** - фоновая обработка не нагружает веб-сервер

## Мониторинг

Для production рекомендуется:
1. Использовать systemd или supervisor для автоматического запуска команды обработки
2. Настроить мониторинг процесса обработки файлов
3. Регулярно очищать временные папки от старых файлов (можно добавить в команду)
4. Настроить ротацию логов
